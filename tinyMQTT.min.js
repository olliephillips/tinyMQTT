(function(){function k(b){if(3===b.charCodeAt(0)>>4){var c=b.charCodeAt(2)<<8|b.charCodeAt(3);b={topic:b.substr(4,c),message:b.substr(4+c,b.charCodeAt(1)-c)};a.emit("message",b)}}function f(a){return e(a.length>>8,a.length&255)+a}function h(a,c,d){return e(a,c.length+d.length)+c+d}function l(b){var c=0;b=f(b);a.usr&&a.pwd&&(c|=a.usr?128:0,c|=a.usr&&a.pwd?64:0,b+=f(a.usr)+f(a.pwd));return h(16,f("MQTT")+e(4,c,255,255),b)}var a,g=function(b,c){var d=c||{};this.svr=b;this.prt=d.port||1883;this.ka=d.keep_alive||
60;this.usr=d.username;this.pwd=d.password;this.cn=!1;this.ri=d.reconnect_interval||2E3;a=this},e=String.fromCharCode;g.prototype._scktClosed=function(){a.con&&(clearInterval(a.con),a.con=null);a.x1&&(clearInterval(a.x1),a.x1=null);a.cn=!1;delete a.cl;a.emit("disconnected")};g.prototype.connect=function(){var b=function(){a.con&&(clearInterval(a.con),a.con=null);try{a.cl.write(l(getSerial())),a.emit("connected"),a.cn=!0,a.x1=setInterval(function(){a.cn&&a.cl.write(e(192,0))},a.ka<<10),a.cl.on("data",
k.bind(a)),a.cl.on("end",a._scktClosed)}catch(c){a._scktClosed()}};a.cn||a.con||(a.con=setInterval(function(){a.cl&&(a.cl.end(),delete a.cl);try{a.cl=require("net").connect({host:a.svr,port:a.prt},b)}catch(c){a._scktClosed()}},a.ri))};g.prototype.subscribe=function(b){a.cl.write(h(130,e(256,1),f(b)+e(0)))};g.prototype.publish=function(b,c){if(127<b.length+c.length)throw"tMQTT-TL";a.cn&&(a.cl.write(h(49,f(b),c)),a.emit("published"))};g.prototype.disconnect=function(){if(a.cn)try{a.cl.write(e(224,0))}catch(b){a._scktClosed()}};
exports.create=function(a,c){return new g(a,c)}})();
