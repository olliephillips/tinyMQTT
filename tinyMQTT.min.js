var TMQ=function(a,b){var c=b||{};this.svr=a;this.prt=c.port||1883;this.usr=c.username;this.pwd=c.password;_q=this},sFCC=String.fromCharCode;function onDat(a){if(3===a.charCodeAt(0)>>4){var b=a.charCodeAt(2)<<8|a.charCodeAt(3);a={topic:a.substr(4,b),message:a.substr(4+b,a.charCodeAt(1)-b)};_q.emit("message",a)}}function mqStr(a){return sFCC(a.length>>8,a.length&255)+a}function mqPkt(a,b,c){return sFCC(a,b.length+c.length)+b+c}
function mqCon(a){var b=0;a=mqStr(a);_q.usr&&_q.pwd&&(b|=_q.usr?128:0,b|=_q.usr&&_q.pwd?64:0,a+=mqStr(_q.usr)+mqStr(_q.pwd));b=sFCC(parseInt(b.toString(16),16));return mqPkt(16,mqStr("MQTT")+"\u0004"+b+"\u00ff\u00ff",a)}
TMQ.prototype.connect=function(){var a=function(){clearInterval(b);_q.cl.write(mqCon(getSerial()));_q.emit("connected");_q.cn=!0;_q.cl.on("data",onDat.bind(_q));_q.cl.on("end",function(){_q.emit("disconnected");_q.cn=_q.cl=null});_q.removeAllListeners("connected")};if(!_q.cn)var b=setInterval(function(){_q.cl=require("net").connect({host:_q.svr,port:_q.prt},a)},2E3)};TMQ.prototype.subscribe=function(a){_q.cl.write(mqPkt(130,sFCC(256,1),mqStr(a)+sFCC(1)))};
TMQ.prototype.publish=function(a,b){_q.cn&&(_q.cl.write(mqPkt(49,mqStr(a),b)),_q.emit("published"))};TMQ.prototype.disconnect=function(){_q.cl.write(sFCC(224)+"\x00")};exports.create=function(a,b){return new TMQ(a,b)};